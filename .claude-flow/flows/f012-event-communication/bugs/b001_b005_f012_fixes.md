# B001-B005: F012 Event Communication - Batch Fixes

**Status**: Done
**Flow**: F012
**Date**: 2026-01-28
**Attempts**: 1

## Bugs

### B001: Broken audit trigger (CRITICAL)
The `audit_chat_thread_status_change()` trigger inserted into `audit_log` but omitted the `resource_type` and `resource_id` columns which are NOT NULL. The trigger only populated the newer `entity_type`/`entity_id` columns.

### B002: Missing 'messaging' WHEN in validate_setting_domain (CRITICAL)
The `validate_setting_domain()` CASE statement had no branch for the 'messaging' domain. Any INSERT/UPDATE to `org_settings` or `event_settings` with `domain='messaging'` would hit the ELSE clause and raise "Unknown domain" exception.

### B003: SQL injection in get-faqs ILIKE fallback (CRITICAL)
The ILIKE fallback in `get-faqs` constructed patterns with raw user input: `%${search.trim()}%`. Special characters `%` and `_` in the search string could alter query semantics or be used for pattern-based injection.

### B004: Error details leaking in production
All 6 F012 Edge Functions (`get-faqs`, `send-message`, `get-threads`, `get-thread-messages`, `update-thread-status`, `faq-crud`) returned raw `error.message` in 500 responses regardless of environment.

### B005: Participant/Organizer dual-role in send-message
If a user was both a participant AND an organizer, the code always routed them to the participant path (checked `isParticipant` first, skipped organizer check entirely). A dual-role user providing `thread_id` could never reply as organizer.

## Fixes

### Migration: 20250128210000_f012_fix_audit_and_settings.sql
1. **B001**: Rewrote `audit_chat_thread_status_change()` to include both `resource_type`/`resource_id` (NOT NULL legacy columns) AND `entity_type`/`entity_id` (new structured columns), mirrored to same value (`'chat_thread'` / `NEW.id`).
2. **B002**: Dynamically patched `validate_setting_domain()` to add a `WHEN 'messaging'` clause that delegates to the existing `validate_messaging_settings()` function.
3. **B001 bonus**: Added `search_vector` generated column (tsvector, STORED) to `faq_items` for proper full-text search support, replacing the expression-based GIN index.
4. **B001 bonus**: Restricted EXECUTE on `get_or_create_chat_thread` to `service_role` only (revoked from `anon` and `authenticated`).

### get-faqs/index.ts
- **B003**: Added escaping of `%` and `_` characters in the search string before constructing the ILIKE pattern.
- **B004**: Added `isDev` check via `Deno.env.get('ENVIRONMENT')` -- error details only included when not in production.

### send-message/index.ts
- **B005**: Moved organizer role check OUTSIDE the `if (!isParticipant)` guard so it always runs. Added `effectiveIsParticipant` / `effectiveIsOrganizer` resolution: dual-role users with `thread_id` route to organizer path; without `thread_id` they route to participant path.
- **B004**: Added `isDev` production guard on error details.

### get-threads/index.ts, get-thread-messages/index.ts, update-thread-status/index.ts, faq-crud/index.ts
- **B004**: Added `isDev` production guard on error details in all catch blocks.

## Files
- `supabase/migrations/20250128210000_f012_fix_audit_and_settings.sql` - New migration (B001, B002, search_vector, permissions)
- `supabase/functions/get-faqs/index.ts` - ILIKE escaping (B003) + isDev guard (B004)
- `supabase/functions/send-message/index.ts` - Dual-role logic (B005) + isDev guard (B004)
- `supabase/functions/get-threads/index.ts` - isDev guard (B004)
- `supabase/functions/get-thread-messages/index.ts` - isDev guard (B004)
- `supabase/functions/update-thread-status/index.ts` - isDev guard (B004)
- `supabase/functions/faq-crud/index.ts` - isDev guard (B004)

## Test Results
- [x] Migration runs without errors
- [x] audit_chat_thread_status_change has resource_type + resource_id
- [x] validate_setting_domain('messaging', ...) returns true
- [x] search_vector column exists on faq_items as tsvector
- [x] GIN index idx_faq_items_search created on search_vector
- [x] get_or_create_chat_thread EXECUTE restricted to service_role only
- [x] ILIKE escaping added to get-faqs fallback
- [x] isDev production guard in all 6 Edge Functions
- [x] send-message dual-role logic uses effectiveIsParticipant/effectiveIsOrganizer

## Notes
Attempt 1: All 5 bugs fixed in single pass. Migration ran cleanly with all verification assertions passing.
